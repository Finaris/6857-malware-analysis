# -*- coding: utf-8 -*-
"""

This module downloads various malicious samples. This
should NOT be run on your own machine! This will make
requests to malicious websites and download malware, so
make sure to plan accordingly.

"""

import json
import os
import urllib.error
import urllib.request

OUTPUT_LOCATION = "malware_samples"

if __name__ == "__main__":
    # First, open the .json which lists all of the domains.
    with open("hosted_malware.json") as file:
        urls = json.load(file)

    # Create the output directory if it does not yet exist.
    if not os.path.exists(OUTPUT_LOCATION):
        os.mkdir(OUTPUT_LOCATION)

    # Iterate through each file and save them locally.
    print(f"Checking {len(urls)} URLs...")
    num_urls_skipped = 0
    for i, url in enumerate(urls):
        # Keep track of our progress.
        if i % 10 == 0:
            print(f"({i}/{len(urls)})")

        # Only consider .exe files
        if ".exe" not in url:
            continue

        # Make the URL use HTTP.
        modified_url = url.replace("https://", "http://")
        if not modified_url.startswith("http://"):
            modified_url = "http://" + modified_url

        file_name = modified_url.split("/")[-1]
        try:
            urllib.request.urlretrieve(modified_url,
                                       os.path.join(OUTPUT_LOCATION, file_name))
            break
        except (urllib.error.HTTPError, urllib.error.URLError):
            num_urls_skipped += 1
    print(f"Process completed: skipped over {num_urls_skipped} URL(s).")
