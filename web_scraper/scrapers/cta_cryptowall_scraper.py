# -*- coding: utf-8 -*-
"""

This module implements the Scraper interface for
CTA Cryptowall for data mining purposes.

"""

import csv
import logging
import os

from datetime import datetime

from scraper import Category, RecordAttribute, Scraper


class CTACryptowallScraper(Scraper):
    """ Implementation of Scraper for CTA Cryptowall. """

    def __init__(self):
        # Specify the short name and move on.
        self.short_name = "cta_cryptowall"
        super().__init__(self.short_name, None, None)

        # Set and clear the remaining class attributes.
        self.base_path = os.path.dirname(os.path.realpath(__file__)) + "/persistent_data/cta_cryptowall/"
        self.files = os.listdir(self.base_path)
        self.records = {}
        self.timestamp = None

    def scrape(self):
        # Before beginning, clear all records and update the timestamp.
        self.records = {}
        self.timestamp = datetime.now()

        # Add each file as a series of records. This is a really easy CSV to pick apart.
        for i, file in enumerate(self.files):
            with open(self.base_path+file) as csv_file:
                records = []
                for j, row in enumerate(csv.reader(csv_file)):
                    # Ignore first row.
                    if j == 0:
                        continue

                    # Process entries and make a new record.
                    new_record = {
                        RecordAttribute.CATEGORY: Category.RANSOMWARE,
                        RecordAttribute.IP: row[2],
                        RecordAttribute.SHA256: row[3],
                        RecordAttribute.URL: row[4],
                        RecordAttribute.DATE: str(datetime.strptime(row[5], "%m/%d/%Y %I:%M:%S %p"))
                    }

                    # Add country if it is provided.
                    if row[1]:
                        new_record[RecordAttribute.ORIGIN_COUNTRY] = row[1]

                    records.append(new_record)
                self.records[file] = records
            logging.info("({0}/{1}): Finished processing {2}".format(i + 1, len(self.files), file))
        logging.info("Completed scraping {0}".format(self.short_name))
